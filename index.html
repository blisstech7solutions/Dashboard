<!DOCTYPE html>
<html lang="en" class="transition duration-300">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unified Admin Dashboard</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#2563EB'
          }
        }
      }
    };
  </script>

  <!-- Bootstrap for Hospital Management -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <style>
    .status-badge { font-size: 0.9em; }
    .approved { color: green; font-weight: bold; }
    .pending { color: orange; font-weight: bold; }
    .rejected { color: red; font-weight: bold; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen p-4 transition duration-300">

  <!-- Navbar with Hamburger Menu -->
  <nav class="bg-white dark:bg-gray-900 shadow-md rounded-md p-3 mb-6">
    <div class="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-4">
      <!-- Left: Logo and Title -->
      <div class="flex items-center gap-3 flex-shrink-0">
        <img src="/BLISS TECH7.png" alt="Logo" class="h-10 w-auto" />
        <h1 class="text-xl font-bold text-primary dark:text-blue-400 select-none"> BlissTech7 Solutins Dashboard</h1>
      </div>

      <!-- Hamburger for mobile -->
      <button id="menu-btn" class="block md:hidden p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary" aria-label="Toggle menu">
        <svg class="h-6 w-6 text-primary dark:text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 8h16M4 16h16"/>
        </svg>
      </button>

      <!-- Right: Menu buttons + unread badge -->
      <div id="menu" class="hidden w-full md:flex md:items-center md:gap-4 md:w-auto">
        <button id="tab-gym" onclick="switchSection('gym')" class="px-4 py-2 rounded-md font-semibold transition-colors duration-200 hover:bg-primary hover:text-white focus:outline-none focus:ring-2 focus:ring-primary">
          Gym
        </button>
        <button id="tab-company" onclick="switchSection('company')" class="px-4 py-2 rounded-md font-semibold transition-colors duration-200 hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary">
          Company
        </button>
        <button id="tab-hospital" onclick="switchSection('hospital')" class="px-4 py-2 rounded-md font-semibold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
          Hospital
        </button>

        <span id="unread-count" class="ml-4 inline-block min-w-[24px] text-center text-white bg-red-600 rounded-full px-2 py-0.5 text-sm font-bold select-none">
          0
        </span>
      </div>
    </div>
  </nav>

  <!-- Sections -->
  <div id="section-gym" class="section hidden">
    <div class="mb-3 text-center">
      <button class="btn btn-outline-primary me-2" onclick="loadGym('all')">All</button>
      <button class="btn btn-outline-success me-2" onclick="loadGym('read')">Read</button>
      <button class="btn btn-outline-warning me-2" onclick="loadGym('unread')">Unread</button>
    </div>
    <div id="gymMessages">Loading gym data...</div>
  </div>

  <div id="section-company" class="section hidden">
    <div class="mb-3 text-center">
      <button class="btn btn-outline-primary me-2" onclick="loadCompany('all')">All</button>
      <button class="btn btn-outline-success me-2" onclick="loadCompany('read')">Read</button>
      <button class="btn btn-outline-warning me-2" onclick="loadCompany('unread')">Unread</button>
    </div>
    <div id="companyMessages">Loading company data...</div>
  </div>

  <!-- Hospital Section -->
  <div id="section-hospital" class="section hidden bg-white dark:bg-gray-800 p-4 rounded shadow overflow-auto" style="max-height: 80vh;">
    <h2 class="text-center text-2xl font-bold mb-4">üè• Hospital & User Control</h2>

    <!-- Hospital/User Tabs -->
    <ul class="nav nav-tabs mb-4" id="dashboardTabs">
      <li class="nav-item"><a class="nav-link active" href="#" onclick="showHospitalSection('hospitals')">Hospitals</a></li>
      <li class="nav-item"><a class="nav-link" href="#" onclick="showHospitalSection('users')">Users</a></li>
    </ul>

    <!-- Hospital Dashboard -->
    <div id="hospitalsSection">
      <div class="grid grid-cols-4 gap-4 mb-4 text-center">
        <div class="border rounded p-3 bg-gray-100 dark:bg-gray-700"><h5>Total</h5><div id="totalCount">0</div></div>
        <div class="border rounded p-3 bg-gray-100 dark:bg-gray-700"><h5>Approved</h5><div id="approvedCount">0</div></div>
        <div class="border rounded p-3 bg-gray-100 dark:bg-gray-700"><h5>Pending</h5><div id="pendingCount">0</div></div>
        <div class="border rounded p-3 bg-gray-100 dark:bg-gray-700"><h5>Rejected</h5><div id="rejectedCount">0</div></div>
      </div>

      <div class="text-center mb-3">
        <button class="btn btn-outline-primary me-2" onclick="loadHospitals('all')">All</button>
        <button class="btn btn-outline-success me-2" onclick="loadHospitals('approved')">Approved</button>
        <button class="btn btn-outline-warning me-2" onclick="loadHospitals('pending')">Pending</button>
        <button class="btn btn-outline-danger me-2" onclick="loadHospitals('rejected')">Rejected</button>
      </div>

      <div id="hospitalList" class="max-h-96 overflow-auto border rounded p-3 bg-gray-100 dark:bg-gray-700"></div>
    </div>

    <!-- Users Dashboard -->
    <div id="usersSection" style="display: none;">
      <div class="grid grid-cols-3 gap-4 mb-4 text-center">
        <div class="border rounded p-3 bg-gray-100 dark:bg-gray-700"><h5>Total Users</h5><div id="totalUsers">0</div></div>
        <div class="border rounded p-3 bg-gray-100 dark:bg-gray-700"><h5>Approved</h5><div id="approvedUsers">0</div></div>
        <div class="border rounded p-3 bg-gray-100 dark:bg-gray-700"><h5>Pending</h5><div id="pendingUsers">0</div></div>
      </div>

      <div class="mb-3 text-center">
        <button class="btn btn-outline-primary me-2" onclick="loadUsers('all')">All</button>
        <button class="btn btn-outline-success me-2" onclick="loadUsers('approved')">Approved</button>
        <button class="btn btn-outline-warning me-2" onclick="loadUsers('pending')">Pending</button>
        <button class="btn btn-outline-info me-2" onclick="loadUsers('provider')">Providers</button>
        <button class="btn btn-outline-dark me-2" onclick="loadUsers('physician')">Physicians</button>
      </div>

      <div id="userList" class="max-h-96 overflow-auto border rounded p-3 bg-gray-100 dark:bg-gray-700"></div>
    </div>
  </div>

  <!-- Script -->
  <script>
    const adminEmail = "vaibhavmalbhage@gmail.com";

    const config = {
      gym: {
        apiKey: "AIzaSyCY5-w3jLyC9iXN8Kh26wGIVia1zGuGwyk",
        authDomain: "gym-management-50b12.firebaseapp.com",
        projectId: "gym-management-50b12"
      },
      company: {
        apiKey: "AIzaSyBYV3M4Wo6bamjNTt5TK6LT_W8NR0ody48",
        authDomain: "fir-application-349d3.firebaseapp.com",
        projectId: "fir-application-349d3"
      },
      hospital: {
        apiKey: "AIzaSyA-e5UveE8KsNuT-d6pYzdYFop3VoTomwk",
        authDomain: "hospital-management-syst-580a4.firebaseapp.com",
        projectId: "hospital-management-syst-580a4"
      }
    };

    const apps = {
      gym: firebase.initializeApp(config.gym, 'gym'),
      company: firebase.initializeApp(config.company, 'company'),
      hospital: firebase.initializeApp(config.hospital, 'hospital')
    };

    const dbs = {
      gym: firebase.firestore(apps.gym),
      company: firebase.firestore(apps.company),
      hospital: firebase.firestore(apps.hospital)
    };

    const sections = ['gym', 'company', 'hospital'];

    function toggleTheme() {
      document.documentElement.classList.toggle("dark");
    }

    function switchSection(section) {
      sections.forEach(s => {
        document.getElementById('tab-' + s).classList.remove("bg-primary", "bg-green-600", "text-white");
        document.getElementById('section-' + s).classList.add("hidden");
      });
      document.getElementById('tab-' + section).classList.add(section === 'hospital' ? 'bg-green-600' : 'bg-primary', 'text-white');
      document.getElementById('section-' + section).classList.remove("hidden");

      if (section === 'gym') loadGym();
      else if (section === 'company') loadCompany();
      else if (section === 'hospital') {
        loadDashboardCounts();
        loadHospitals('all');
        loadUsers('all');
      }
    }

    // Gym messages loader with filter
    async function loadGym(filter = 'all') {
      let query = dbs.gym.collection("contactMessages").orderBy("timestamp", "desc");
      if (filter === 'read') query = query.where("read", "==", true);
      else if (filter === 'unread') query = query.where("read", "==", false);

      const snap = await query.get();
      renderMessages("gym", snap, "gymMessages");
    }

    // Company messages loader with filter
    async function loadCompany(filter = 'all') {
      let query = dbs.company.collection("messages").orderBy("timestamp", "desc");
      if (filter === 'read') query = query.where("read", "==", true);
      else if (filter === 'unread') query = query.where("read", "==", false);

      const snap = await query.get();
      renderMessages("company", snap, "companyMessages");
    }

    async function renderMessages(app, snap, elementId) {
      let html = "", unreadCount = 0;
      snap.forEach(doc => {
        const d = doc.data();
        if (!d.read) unreadCount++;
        html += `
          <div class='p-4 mb-2 bg-white dark:bg-gray-800 rounded shadow'>
            <strong>${d.name}</strong><br>${d.email}<br>${d.message}<br>
            <button class='bg-green-500 text-white px-2 py-1 mt-2 rounded me-2' onclick='markAsRead("${app}", "${doc.id}")'>Mark as Read</button>
            <button class='bg-blue-500 text-white px-2 py-1 mt-2 rounded' onclick='markAsUnread("${app}", "${doc.id}")'>Mark as Unread</button>
          </div>
        `;
      });
      document.getElementById(elementId).innerHTML = html || "<p>No messages found.</p>";
      updateUnreadCount();
    }

    async function markAsRead(app, id) {
      await dbs[app].collection(app === 'company' ? 'messages' : 'contactMessages').doc(id).update({ read: true });
      switchSection(app); // reload current section
    }

    async function markAsUnread(app, id) {
      await dbs[app].collection(app === 'company' ? 'messages' : 'contactMessages').doc(id).update({ read: false });
      switchSection(app); // reload current section
    }

    async function updateUnreadCount() {
      const gymSnap = await dbs.gym.collection("contactMessages").where("read", "==", false).get();
      const companySnap = await dbs.company.collection("messages").where("read", "==", false).get();
      const count = gymSnap.size + companySnap.size;
      document.getElementById("unread-count").innerText = count;
    }

    // Hospital section functions (unchanged)
    function showHospitalSection(section) {
      document.getElementById("hospitalsSection").style.display = section === 'hospitals' ? 'block' : 'none';
      document.getElementById("usersSection").style.display = section === 'users' ? 'block' : 'none';
      const tabs = document.querySelectorAll('#section-hospital .nav-link');
      tabs.forEach(tab => tab.classList.remove('active'));
      tabs.forEach(tab => {
        if (tab.textContent.toLowerCase() === section) tab.classList.add('active');
      });
    }

    async function loadDashboardCounts() {
      const snap = await dbs.hospital.collection("hospitals").get();
      let total = 0, approved = 0, pending = 0, rejected = 0;
      snap.forEach(doc => {
        const h = doc.data();
        total++;
        if (h.status === 'approved') approved++;
        else if (h.status === 'pending') pending++;
        else if (h.status === 'rejected') rejected++;
      });
      document.getElementById("totalCount").innerText = total;
      document.getElementById("approvedCount").innerText = approved;
      document.getElementById("pendingCount").innerText = pending;
      document.getElementById("rejectedCount").innerText = rejected;
    }

    async function loadHospitals(status) {
      let query = dbs.hospital.collection("hospitals");
      if (status !== 'all') query = query.where("status", "==", status);
      const snap = await query.orderBy("createdAt", "desc").get();
      let html = "";
      snap.forEach(doc => {
        const h = doc.data();
        html += `<div class="mb-3 border-bottom pb-2">
          <h5>${h.hospitalName || h.name}</h5>
          <p>${h.hospitalAddress || h.address}</p>
          <p><strong>Doctor:</strong> ${h.doctorName || 'N/A'} (${h.doctorSpecialty || 'N/A'})</p>
          <p><strong>Education:</strong> ${h.doctorEducation || 'N/A'}</p>
          <small>
            Email: ${h.hospitalEmail || 'N/A'}<br>
            Provider: ${h.providerEmail || h.createdBy || 'N/A'}<br>
            Partner: ${h.partnerEmail || 'N/A'}<br>
            Created: ${h.createdAt?.toDate().toLocaleString() || 'N/A'}<br>
            Updated: ${h.updatedAt?.toDate().toLocaleString() || 'N/A'}
          </small><br>
          <span class="status-badge ${h.status}">Status: ${h.status}</span><br>
          ${h.status === 'pending' ? `
            <button class="btn btn-sm btn-success me-2" onclick="approveHospital('${doc.id}')">Approve</button>
            <button class="btn btn-sm btn-danger me-2" onclick="rejectHospital('${doc.id}')">Reject</button>` : ''}
          <button class="btn btn-sm btn-outline-danger" onclick="deleteHospital('${doc.id}')">Delete</button>
        </div>`;
      });
      document.getElementById("hospitalList").innerHTML = html || "<i>No hospitals found.</i>";
    }

    async function approveHospital(id) {
      await dbs.hospital.collection("hospitals").doc(id).update({ status: "approved" });
      await loadDashboardCounts();
      await loadHospitals('pending');
    }

    async function rejectHospital(id) {
      await dbs.hospital.collection("hospitals").doc(id).update({ status: "rejected" });
      await loadDashboardCounts();
      await loadHospitals('pending');
    }

    async function deleteHospital(id) {
      if (confirm("Delete this hospital?")) {
        await dbs.hospital.collection("hospitals").doc(id).delete();
        await loadDashboardCounts();
        await loadHospitals('all');
      }
    }

    async function loadUsers(status) {
      let query = dbs.hospital.collection("users");
      if (status !== 'all' && status !== 'provider' && status !== 'physician') {
        query = query.where("status", "==", status);
      } else if (status === 'provider' || status === 'physician') {
        query = query.where("role", "==", status);
      }
      const snap = await query.orderBy("createdAt", "desc").get();
      let html = "";
      snap.forEach(doc => {
        const u = doc.data();
        html += `<div class="mb-3 border-bottom pb-2">
          <h5>${u.name || u.displayName || 'No Name'}</h5>
          <p>Email: ${u.email}</p>
          <p>Role: ${u.role}</p>
          <p>Status: ${u.status}</p>
          <small>Created: ${u.createdAt?.toDate().toLocaleString() || 'N/A'}</small><br>
          ${u.status === 'pending' ? `
            <button class="btn btn-sm btn-success me-2" onclick="approveUser('${doc.id}')">Approve</button>
            <button class="btn btn-sm btn-danger me-2" onclick="rejectUser('${doc.id}')">Reject</button>` : ''}
          <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${doc.id}')">Delete</button>
        </div>`;
      });
      document.getElementById("userList").innerHTML = html || "<i>No users found.</i>";
    }

    async function approveUser(id) {
      await dbs.hospital.collection("users").doc(id).update({ status: "approved" });
      await loadUsers('pending');
    }

    async function rejectUser(id) {
      await dbs.hospital.collection("users").doc(id).update({ status: "rejected" });
      await loadUsers('pending');
    }

    async function deleteUser(id) {
      if (confirm("Delete this user?")) {
        await dbs.hospital.collection("users").doc(id).delete();
        await loadUsers('all');
      }
    }

    // Initialize view on page load
    window.onload = () => {
      switchSection('gym');  // default gym section
    };

    // Hamburger menu toggle for mobile
    const menuBtn = document.getElementById('menu-btn');
    const menu = document.getElementById('menu');

    menuBtn.addEventListener('click', () => {
      menu.classList.toggle('hidden');
    });

    // Adjust menu display on window resize
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 768) {
        menu.classList.remove('hidden');
      } else {
        menu.classList.add('hidden');
      }
    });

    if(window.innerWidth >= 768){
      menu.classList.remove('hidden');
    }
  </script>

</body>
</html>
